<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>UNINETT WebAPP Demo</title>

	<style>
		div#out p {
			color: #555;
		}
		dl dd {

		}
		div#chatoutput p {
			margin: 5px;
			border-top: 1px solid #ccc;
			padding: 4px;

		}
	</style>

	<!-- JQuery hosted by Google -->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js" type="text/javascript"></script>
	<!-- Core API to UNINETT WebApp Park -->
	<script type="text/javascript" src="/_/js/core.js"></script>

	<script type="text/javascript">


		var groups = {};
		function getGroup(id) {
			if (id === '!public') return 'Public';
			if (groups[id]) return groups[id];
			return 'unknown group (' + id + ')';
		}

		function loggedin(user) {
			$("div#out").prepend('<p>Logged in as <strong>' + user.name + '</strong> (<tt>' + user.userid + '</tt>)</p>');
			$("input#smt").attr('disabled', 'disabled');



			var gr = $('<dl></dl>')
			if(user.groups) {
				groups = user.groups;
				for(var key in user.groups) {
					gr.append('<dt>' + user.groups[key] + '</dt>');
					gr.append('<dd><tt>' + key + '</tt></dd>');

				}
			}
			$("div#out").append('<p>Groups:</p>').append(gr);


			$("div#chatgroups").empty().append('<input type="checkbox" id="!public" name="!public"><label for="!public">Public</label> ');
			if(user.groups) {
				for(var key in user.groups) {
					$("div#chatgroups").append('<input type="checkbox" name="' + key + '" id="' + key + '"><label for="' + key + '">' + 
						user.groups[key] + '</label> ');
				}
			}

		}
		function notloggedin() {
			$("div#out").prepend('<p>Not logged in</p>');
		}

		function weatherresult(w) {
			console.log(w);
		}
		
		function vegmelding(v) {
			$(v['result-array'].result.messages.message).each(function(c, i) {
				console.log(i);
				$("div#out").append('<h2>' + i.heading + '</h2><p>' + i.ingress + '</p>');
			});
		}
		
		function generic(o) {
			var k;
			for (k in o) {
				
				$("div#out").append('<p>' + k + ' :  ' + o[k] + '</p>');
			}
		}


		function showfacebook(o) {
			var k;
			// console.log(o);
			for (k in o.data) {
				console.log(o.data[k]);
				var entry = $('<p>[' + o.data[k].type + '] :  ' + o.data[k].message + '</p>');
				for(var i = 0; i < o.data[k].actions.length; i++) {
					entry.append(' <a href="' + o.data[k].actions[i].link + '">' + o.data[k].actions[i].name + '</a>' );
				}
				$("div#out").append(entry);
			}
			$("input#facebook").attr('disabled', 'disabled');
	
		}


		function activity(as) {
			console.log('Got activity');
			$(as.data).each(function(i, a) {
				var html = '<h2 style="font-size: 110%; color: #222"><a style="color: #333" href="https://foodl.org/foodle/' + a.foodle.id + '">' + a.foodle.name + '</a></h2>';
				if (a.ago) {
					html += '<p style="color: #944">Updated ' + a.ago + '</p>';
				}
				if (a.foodle.summary) {
					html += '<p>' + a.foodle.summary + '</p>';
				}
				$("div#out").append(html);
			});
			console.log(as);
		}

		function secondsT(sec) {
			var minutes = 0;

			if (sec <= 60) {
				return sec + ' sekunder';
			} else {
				minutes = Math.floor(sec/60);
				sec = sec - (minutes*60);
				return minutes + ' min ' + sec + ' sek';
			}
		} 

		function bussResult(r) {
			console.log(r);

			$.each(r.departures, function(i, item) {

				// var sanntid = Date.parse(item.registeredDepartureTime);


				// var until = (sanntid - now) / 1000;

				// var rdt = Date.parse("2012-04-20T" + item.registeredDepartureTime.substr(11,5));
				// var sdt = Date.parse("2012-04-20T" + item.scheduledDepartureTime.substr(11,5));

				var now = new Date(); 
				var rdt = new Date(); 
				rdt.setHours(item.registeredDepartureTime.substr(11,2));
				rdt.setMinutes(item.registeredDepartureTime.substr(14,2));
				rdt.setSeconds(0);

				var sdt = new Date();
				sdt.setHours(item.scheduledDepartureTime.substr(11,2));
				sdt.setMinutes(item.scheduledDepartureTime.substr(14,2));
				sdt.setSeconds(0);

				var diff = Math.floor((rdt - sdt) / (60*1000));
				var until = (rdt - now) / 1000;


				console.log(rdt);
				console.log(sdt);
				console.log("-----");
				console.log(item.registeredDepartureTime.substr(11,5));
				console.log(item.scheduledDepartureTime.substr(11,5));

				var tid = item.registeredDepartureTime.substr(11,5);

				
				var real = (item.isRealtimeData ? 'Sanntid' : 'Rute');
				$("div#out").append('<p><span class="line">' + item.line + " " + item.destination + "</span> " + tid + " " + real +  " " + diff  + " forsinket " + secondsT(until) + " sekunder til avgang</p>");
			});

		}
		function bussRequest() {
			var bussurl = "http://api.busbuddy.no:8080/api/1.3/departures/16011125";
			UWAP.data.get(bussurl, {handler: "buss"}, bussResult);
		}

		function updateChatResponse(data) {
			console.log("chat result", data);
			$("div#chatoutput").empty();
			$.each(data, function(i, msg) {
				console.log("Chat entry", i, msg);
				var ce = $('<p><span style="color: #999">' + msg['uwap-userid'] + '</span> ' + msg.msg + '</p>');
				if (msg.hasOwnProperty("uwap-acl-read")) {
					$.each(msg["uwap-acl-read"], function(j, item) {
						console.log("ACL READ item", item);
						ce.append('<span style="margin: 0px 10px; background: #ccc; padding: 2px; border-radius: 3px">' + getGroup(item) + '</span>');
					});
				}
				console.log(ce);
				$("div#chatoutput").prepend(ce);
			});
		}

		function updateChat() {
			UWAP.store.queryList({type: "msg"}, updateChatResponse);
		}

		setInterval(updateChat, 10000);

		$("document").ready(function() {
			
			UWAP.auth.check(loggedin, notloggedin);
			// 
			$("input#smt").click(function() {
				UWAP.auth.require(loggedin);
			});
			
			$("input#facebook").click(function() {
				UWAP.data.get('https://graph.facebook.com/me/home', {handler: "facebook"}, showfacebook);
			});

			updateChat();
			$("input#chatmsg").focus().bind("change", function(data) {
				var msg = $("input#chatmsg").attr("value") ;
				console.log("Chat msg: " + msg);

				if (msg === '') return false;

				var groups = [];
				$("div#chatgroups input").each(function(i, item) {
					var grid = $(item).attr("name");
					if ($(item).prop("checked")) {
						groups.push(grid);
					}
					console.log("group found ", grid);
				});

				var msgobj = {
					"type": "msg",
					"msg": msg
				};
				if (groups) {
					msgobj["uwap-acl-read"] = groups;
				}

				UWAP.store.save(msgobj, function(d) {
					console.log("completed store function...");
					updateChat();
				});

				$("input#chatmsg").attr("value", "");
			});

			// UWAP.data.get('http://www.vegvesen.no/trafikk/xml/savedsearch.xml?id=600', 
			// 	{'xml': 1},
			// 	vegmelding);
			
			// UWAP.data.get('https://foodl.org/api/activity', {handler: "foodle"}, activity);
			// UWAP.data.get('http://bridge.uninett.no/rest.php', {handler: "plain"}, generic);

			// 

			bussRequest();

			// UWAP.store.save(
			// 	{
			// 		"test": "value",
			// 		"size": Math.floor(Math.random()*1000),
			// 		"bool": true
			// 		// "speed": 1.2333,
			// 		// "geolocation": {
			// 		// 	"city": "Trondheim",
			// 		// 	"code": "7040"
			// 		// }
			// 	}, function() {
			// 		console.log("Successfully stored object.")
			// 	}, function(err) {
			// 		console.log("Error storing object: " + err.message)
			// 	}
			// );

			// UWAP.store.queryList(
			// 	{"bool": true},
			// 	function(res) {
			// 		console.log(res);
			// 	}, function(err) {
			// 		console.log(err);
			// 	}
			// );

			// UWAP.store.queryOne(
			// 	{"bool": true},
			// 	function(res) {
			// 		console.log("Query one returned result:");
			// 		console.log(res);
			// 		res.text = "Modified2";

			// 		console.log("Is about to save entry with id: " + res["_id"]["$id"]);
					

			// 		UWAP.store.save(res, function() {
			// 			console.log("Successfully stored modified attribute");
			// 		});
			// 	}
			// );
			
			// if (navigator.geolocation) {
			// 	console.log('s1');
			// 	navigator.geolocation.getCurrentPosition(function(position) {
			// 	console.log('s2');					
			// 		UWAP.data.get('http://api.yr.no/weatherapi/oceanforecast/0.9/?lat=' + position.coords.latitude  + ';lon=' + position.coords.longitude  + '', 
			// 			{'xml': 1},
			// 			weatherresult);
			// 		
			// 	});
			// }
		});

	</script>
	
	
	
</head>

<body style="background: #400; color: #222; padding: 3em; font-family: sans-serif">


	<img src="https://www.uninett.no/sites/drupal.uninett.no.uninett/themes/uninett_2012/images/logo.png" style="" />	

	<p style="">UNINETT WebAPP Demo</p>

	<p><a href="http://store.app.bridge.uninett.no">App store</a></p>

	<input type="submit" id="smt" name="smt" value="Require login" />
	<input type="submit" id="facebook" name="facebook" value="Load facebook" />

	<div style="border: 1px solid #622; border-radius: 5px;  background: #eee; padding: 2em 1em;">
		<h2>eduChat</h2>
		<div id="chatgroups"></div>
		<input type="text" id="chatmsg" name="chatmsg" value="" style="width: 80%; font-size: 110%" />
		<div id="chatoutput"></div>
	</div>

	<div id="out" style="margin: 2em 0px; background: #eee; border: 1px solid #ccc; padding: 1em"></div>


	

</body>
</html>








